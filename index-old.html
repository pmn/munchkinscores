<html>
<head>
    <title>Munchkin scores</title>
    <script type='text/javascript' src='https://cdn.firebase.com/v0/firebase.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="static/js/masonry.min.js"></script>
</head>
<body>
    <h1>Munchkin scores</h1>
    <h2>cool!</h2>
    <table id="scoreTable"></table>
    <input type="text" id="nameInput" placeholder="Name">
    <input type="text" id="scoreInput" placeholder="Score">

    <script type='text/javascript'>
        // Original code from https://www.firebase.com/tutorial/index.html#session/s90i28zp6ka
        var munchkinRef = new Firebase('https://munchkinscores.firebaseio.com/');
        var PLAYER_COUNT = 10;
        // Keep a mapping of firebase locations to HTML elements, so we can move /remove items
        var htmlForPath = {};

        // Helper function for scores
        function handleScoreChanged(scoreSnapshot, prevScoreName) {
            var newScoreRow = $("<tr />");
            newScoreRow.append($("<td />").append($("<em/>").text(scoreSnapshot.val().name)));
            newScoreRow.append($("<td/>").text(scoreSnapshot.val().score));

            // store a reference to the row
            htmlForPath[scoreSnapshot.name()] = newScoreRow;

            // Insert the new score in the appropriate place in the table.
            if (prevScoreName === null){ 
                $("#scoreTable").append(newScoreRow);
            } else {
                var lowerScorewRow = htmlForPath[prevScoreName];
                lowerScorewRow.before(newScoreRow);
            }
        }

        // Helper function to handle a score object being removed
        function handleScoreRemoved(scoreSnapshot){
            var removedScoreRow = htmlForPath[scoreSnapshot.name()];
            removedScoreRow.remove();

            delete htmlForPath[scoreSnapshot.name()];
        }

        var scoreListView = munchkinRef.limit(PLAYER_COUNT);

        scoreListView.on('child_added', function(newScoreSnapshot, prevScoreName){
            handleScoreChanged(newScoreSnapshot, prevScoreName);
        });

        scoreListView.on('child_removed', function (oldScoreSnapshot) {
            handleScoreRemoved(oldScoreSnapshot);
        });

        // add a callback to handle when a score cahnges or moves positions.
        var changedCallback = function (scoreSnapshot, prevScoreName) {
            handleScoreRemoved(scoreSnapshot);
            handleScoreChanged(scoreSnapshot, prevScoreName);
        };

        scoreListView.on('child_moved', changedCallback);
        scoreListView.on('child_changed', changedCallback);

        $("#scoreInput").keypress(function (e) {
            if (e.keyCode == 13) {
                var newScore = Number($("#scoreInput").val());
                var name = $("#nameInput").val();

                $("#scoreInput").val("");

                if (name.length === 0)
                    return;

                var userScoreRef = munchkinRef.child(name);

                // use setWithPriority to put the name / score in firebase 
                userScoreRef.setWithPriority({ name:name, score:newScore }, newScore);
            }
        })

    </script>
</body>
</html>
